

// ==========================================
// ARCHIVO: c:\laragon\www\Proyecto de flotas\Sistema-de-Monitoreo-Operativo-de-vehiculos\backend\infraestructura\repositorios\ConductorRepositorio.ts
// ==========================================

import { IConductorRepositorio } from "../../dominio/Repositorios/IConductorRepositorio";
import { Conductor } from "../../dominio/Entidades/Conductor";
import { pool } from "../../db";

export class ConductorRepositorio implements IConductorRepositorio {

    async guardar(conductor: Conductor): Promise<void> {
        const connection = await pool.getConnection();
        try {
            await connection.beginTransaction();

            const [userResult]: any = await connection.query(
                'INSERT INTO usuarios (nombre, email, contraseña, rol) VALUES (?, ?, ?, ?)',
                [conductor.getNombre(), conductor.getEmail(), "password_placeholder", 'conductor']
            );
            const userId = userResult.insertId;

            await connection.query(
                'INSERT INTO conductores (usuario_id, licencia, telefono, sueldo,edad, disponible) VALUES (?, ?, ?, ?, ?,?)',
                [userId, conductor.getLicencia(), conductor.getTelefono(), conductor.getSueldo(),conductor.getEdad(), conductor.EstadoDisponible()]
            );

            await connection.commit();
        } catch (error) {
            await connection.rollback();
            throw error;
        } finally {
            connection.release();
        }
    }

    async obtenerPorId(id: string): Promise<Conductor | null> {
        const [rows]: any = await pool.query(
            `SELECT u.id, u.nombre, u.email, u.contraseña, c.licencia, c.telefono, c.sueldo, c.disponible 
             FROM usuarios u 
             JOIN conductores c ON u.id = c.usuario_id 
             WHERE u.id = ?`,
            [id]
        );

        if (rows.length === 0) return null;

        const row = rows[0];
        return new Conductor(
            row.id.toString(),
            row.nombre,
            row.email,
            row.contraseña,
            row.licencia,
            Number(row.telefono),
            Number(row.sueldo),
            Number(row.edad),
            Boolean(row.disponible)
        );
    }

    async obtenerTodos(): Promise<Conductor[]> {
        const [rows]: any = await pool.query(
            `SELECT u.id, u.nombre, u.email, u.contraseña, c.licencia, c.telefono, c.sueldo, c.disponible 
             FROM usuarios u 
             JOIN conductores c ON u.id = c.usuario_id`
        );

        return rows.map((row: any) => new Conductor(
            row.id.toString(),
            row.nombre,
            row.email,
            row.contraseña,
            row.licencia,
            Number(row.telefono),
            Number(row.sueldo),
            Number(row.edad),
            Boolean(row.disponible)
        ));
    }

    async actualizar(conductor: Conductor): Promise<void> {
        const connection = await pool.getConnection();
        try {
            await connection.beginTransaction();

            await connection.query(
                'UPDATE usuarios SET nombre = ?, email = ? WHERE id = ?',
                [conductor.getNombre(), conductor.getEmail(), conductor.getId()]
            );

            await connection.query(
                'UPDATE conductores SET licencia = ?, telefono = ?, sueldo = ?, disponible = ? WHERE usuario_id = ?',
                [conductor.getLicencia(), conductor.getTelefono(), conductor.getSueldo(), conductor.EstadoDisponible(), conductor.getId()]
            );

            await connection.commit();
        } catch (error) {
            await connection.rollback();
            throw error;
        } finally {
            connection.release();
        }
    }

    async eliminar(id: string): Promise<void> {
        await pool.query('DELETE FROM usuarios WHERE id = ?', [id]);
    }
}


// ---- FIN DE ARCHIVO ----


// ==========================================
// ARCHIVO: c:\laragon\www\Proyecto de flotas\Sistema-de-Monitoreo-Operativo-de-vehiculos\backend\infraestructura\repositorios\UbicacionRepositorio.ts
// ==========================================

import { IUbicacionRepositorio } from "../../dominio/Repositorios/IUbicacionRepositorio";
import { UbicacionGPS } from "../../dominio/Entidades/UbicacionGPS";
import { pool } from "../../db";

export class UbicacionRepositorio implements IUbicacionRepositorio {

    async guardar(ubicacion: UbicacionGPS): Promise<void> {
        await pool.query(
             'INSERT INTO ubicaciones_gps (viaje_id, timestamp, latitud, longitud, velocidad) VALUES (?, ?, ?, ?, ?)',
            [ubicacion.getIdViaje(), ubicacion.getFechaHora(), ubicacion.getLatitud(), ubicacion.getLongitud(), ubicacion.getVelocidad()]
         );
    }

    async obtenerPorViaje(idViaje: string): Promise<UbicacionGPS[]> {
         const [rows]: any = await pool.query(
            'SELECT * FROM ubicaciones_gps WHERE viaje_id = ? ORDER BY timestamp ASC',
            [idViaje]
        );

        return rows.map((row: any) => new UbicacionGPS(
            row.viaje_id.toString(),
            Number(row.latitud),
             Number(row.longitud),
            row.timestamp,
             Number(row.velocidad)
        ));
    }

            async obtenerUltimaPorViaje(idViaje: string): Promise<UbicacionGPS | null> {
                const [rows]: any = await pool.query(
                    'SELECT * FROM ubicaciones_gps WHERE viaje_id = ? ORDER BY timestamp DESC LIMIT 1',
                    [idViaje]
                );

                if (rows.length === 0) return null;

                const row = rows[0];
                return new UbicacionGPS(
                    row.viaje_id.toString(),
                    Number(row.latitud),
                    Number(row.longitud),
                    row.timestamp,
                    Number(row.velocidad)
                );
            }
        }


// ---- FIN DE ARCHIVO ----


// ==========================================
// ARCHIVO: c:\laragon\www\Proyecto de flotas\Sistema-de-Monitoreo-Operativo-de-vehiculos\backend\infraestructura\repositorios\UsuarioRepositorio.ts
// ==========================================

import { IUsuarioRepositorio } from "../../dominio/Repositorios/IUsuarioRepositorio";
import { usuario } from "../../dominio/Entidades/usuario";
import { pool } from "../../db";

export class UsuarioRepositorio implements IUsuarioRepositorio {
    async obtenerPorEmail(email: string): Promise<usuario | null> {
        const [rows]: any = await pool.query(
            "SELECT id, nombre, email, contraseña FROM usuarios WHERE email = ?",
            [email]
        );
        if (rows.length === 0) return null;

        const row = rows[0];
        return new usuario(
            row.id.toString(),
            row.nombre,
            row.email,
            row.contraseña
        );
    }

    async guardar(user: usuario): Promise<void> {
        await pool.query(
            "INSERT INTO usuarios (nombre, email, contraseña) VALUES (?, ?, ?)",
            [user.getNombre(), user.getEmail(), "password_placeholder"]
        );
    }
}


// ---- FIN DE ARCHIVO ----


// ==========================================
// ARCHIVO: c:\laragon\www\Proyecto de flotas\Sistema-de-Monitoreo-Operativo-de-vehiculos\backend\infraestructura\repositorios\VehiculoRepositorio.ts
// ==========================================

import { IVehiculoRepositorio } from "../../dominio/Repositorios/IVehiculoRepositorio";
import { Vehiculo } from "../../dominio/Entidades/Vehiculo";
import { EstadoVehiculo } from "../../dominio/emuns/EstadoVehiculo";
import { pool } from "../../db";

export class VehiculoRepositorio implements IVehiculoRepositorio {

    async guardar(vehiculo: Vehiculo): Promise<void> {
        const [estadoResult]: any = await pool.query('SELECT id FROM estado_vehiculo WHERE nombre = ?', [vehiculo.getestado()]);
        const estadoId = estadoResult[0]?.id;

        await pool.query(
            'INSERT INTO vehiculos (marca, placa, modelo, año, capacidad, kilometraje, estado_id) VALUES (?, ?, ?, ?, ?, ?, ?)',
            [vehiculo.getMarca(), vehiculo.getplaca(), vehiculo.getmodelo(), vehiculo.getAño(), vehiculo.getcapacidad(), vehiculo.getkilometraje(), estadoId]
        );
    }

    async obtenerPorPlaca(placa: string): Promise<Vehiculo | null> {
        const [rows]: any = await pool.query(
            `SELECT v.*, e.nombre as estado_nombre 
             FROM vehiculos v 
             JOIN estado_vehiculo e ON v.estado_id = e.id 
             WHERE v.placa = ?`,
            [placa]
        );

        if (rows.length === 0) return null;

        const row = rows[0];
        return new Vehiculo(
            row.id.toString(),
            row.marca,
            row.placa,
            row.modelo,
            row.capacidad,
            row.kilometraje,
            row.estado_nombre as EstadoVehiculo,
            row.año
        );
    }

    async obtenerTodos(): Promise<Vehiculo[]> {
         const [rows]: any = await pool.query(
            `SELECT v.*, e.nombre as estado_nombre 
               FROM vehiculos v 
              JOIN estado_vehiculo e ON v.estado_id = e.id`
        );

         return rows.map((row: any) => new Vehiculo(
            row.id.toString(),
             row.marca,
            row.placa,
            row.modelo,
             row.capacidad,
            row.kilometraje,
             row.estado_nombre as EstadoVehiculo,
            row.año
        ));
     }

 async actualizar(vehiculo: Vehiculo): Promise<void> {
         const [estadoResult]: any = await pool.query('SELECT id FROM estado_vehiculo WHERE nombre = ?', [vehiculo.getestado()]);
        const estadoId = estadoResult[0]?.id;

        await pool.query(
             'UPDATE vehiculos SET marca = ?, modelo = ?, año = ?, capacidad = ?, kilometraje = ?, estado_id = ? WHERE placa = ?',
            [vehiculo.getMarca(), vehiculo.getmodelo(), vehiculo.getAño(), vehiculo.getcapacidad(), vehiculo.getkilometraje(), estadoId, vehiculo.getplaca()]
        );
    }

 async eliminar(placa: string): Promise<void> {
        await pool.query('DELETE FROM vehiculos WHERE placa = ?', [placa]);
    }
}


// ---- FIN DE ARCHIVO ----


// ==========================================
// ARCHIVO: c:\laragon\www\Proyecto de flotas\Sistema-de-Monitoreo-Operativo-de-vehiculos\backend\infraestructura\repositorios\ViajeRepositorio.ts
// ==========================================

import { IVehiculoRepositorio } from "../../dominio/Repositorios/IVehiculoRepositorio";
import { Vehiculo } from "../../dominio/Entidades/Vehiculo";
import { Estado_Vehiculo } from "../../dominio/emuns/Estado_Vehiculo";
import { pool } from "../../db";

export class VehiculoRepositorio implements IVehiculoRepositorio {

    async guardar(vehiculo: Vehiculo): Promise<void> {
        const [estadoResult]: any = await pool.query('SELECT id FROM estado_vehiculo WHERE nombre = ?', [vehiculo.getestado()]);
        const estadoId = estadoResult[0]?.id;

        await pool.query(
            'INSERT INTO vehiculos (placa, modelo, capacidad, kilometraje, estado_id) VALUES (?, ?, ?, ?, ?)',
            [vehiculo.getplaca(), vehiculo.getmodelo(), vehiculo.getcapacidad(), vehiculo.getkilometraje(), estadoId]
        );
    }

    async obtenerPorPlaca(placa: string): Promise<Vehiculo | null> {
        const [rows]: any = await pool.query(
            `SELECT v.*, e.nombre as estado_nombre 
             FROM vehiculos v 
             JOIN estado_vehiculo e ON v.estado_id = e.id 
             WHERE v.placa = ?`,
            [placa]
        );

        if (rows.length === 0) return null;

        const row = rows[0];
        return new Vehiculo(
            row.id.toString(),
            "", 
            row.placa,
            row.modelo,
            row.capacidad,
            row.kilometraje,
            row.estado_nombre as Estado_Vehiculo,
            0 // Año no estaba en el SQL
        );
    }

    async obtenerTodos(): Promise<Vehiculo[]> {
        const [rows]: any = await pool.query(
            `SELECT v.*, e.nombre as estado_nombre 
             FROM vehiculos v 
             JOIN estado_vehiculo e ON v.estado_id = e.id`
        );

        return rows.map((row: any) => new Vehiculo(
            row.id.toString(),
            "",
            row.placa,
            row.modelo,
            row.capacidad,
            row.kilometraje,
            row.estado_nombre as Estado_Vehiculo,
            0
        ));
    }

    async actualizar(vehiculo: Vehiculo): Promise<void> {
        const [estadoResult]: any = await pool.query('SELECT id FROM estado_vehiculo WHERE nombre = ?', [vehiculo.getestado()]);
        const estadoId = estadoResult[0]?.id;

        await pool.query(
            'UPDATE vehiculos SET modelo = ?, capacidad = ?, kilometraje = ?, estado_id = ? WHERE placa = ?',
            [vehiculo.getmodelo(), vehiculo.getcapacidad(), vehiculo.getkilometraje(), estadoId, vehiculo.getplaca()]
        );
    }

    async eliminar(placa: string): Promise<void> {
        await pool.query('DELETE FROM vehiculos WHERE placa = ?', [placa]);
    }
}


// ---- FIN DE ARCHIVO ----
